<div class="container-<%= @post.id %>" style="background-color: white; border: #777777 solid 1px; margin-top: 100px;
    border-radius:
    3px; padding: 20px; box-shadow: 0 0 10px 5px rgba(221, 221, 221, 1);">
<div class="row">
  <div class="col-6" style="border-bottom: #777777 solid 1px; ">
    <p style="margin-top: 5px">login: <span><%= @post.user.login %></span>
      <%= image_tag "#{@post.user.avatar.versions[:preview]}", class: "img-thumbnail" %>
    </p>
    <p>Raiting: </p>
  </div>
    <div class="col-12" >
      <h3>Question: <span><%= @post.header %></span></h3>
    </div>
</div>

<br>

<div class="row">
<div class="col-12" style="border: #777777 solid 1px; border-radius: 4px; background-color: #f2f2f2">
  <p>Description:</p>
  <div class="row">
    <div class="col-8" style="padding-bottom: 10px">
      <%= @post.body %>
    </div>
  </div>
</div>
</div>

<!--Текущий пользователь не может отвечать на свои посты-->
<p>Tagging: </p><%= raw @post.tags.map{ |t| link_to t.name, tag_path(t.id), class: "badge badge-secondary" }.join(" ") %>
<div class="row footer-tag">
  <div class="col-12 text-right">
    <%= link_to "Edit", edit_category_post_path(params[:category_id], params[:id]), class: "btn btn-primary", style: "margin: 25px 5px" if current_user %>
    <%= link_to "Answer", new_category_post_answer_path(params[:category_id], params[:id]), class: "btn btn-primary",
                id: "answer", style: "margin: 25px 5px" if logged_in? %>
  </div>
  <div class="col-12 text-right">
    <%= link_to like_category_post_path(params[:category_id], params[:id]), class: "like", remote: true,
                 method: :put do %>
      <%= image_tag "thumb-up.png" %>
      <span class="like-size"><%= @post.get_upvotes.size %></span>
  <% end %>
    <%= link_to deslike_category_post_path(params[:category_id], params[:id]), class: "deslike", remote: true,
                 method: :put do %>
      <%= image_tag "thumb-down.png" %>
      <span class="deslike-size"><%= @post.get_downvotes.size %></span>
    <% end %>
  </div>
</div>
</div>

<%# binding.pry %>
<div class="row">
  <div class="col-12">
    <% unless @post.answers.empty? %>
      <%= content_tag :h3, "Answers:" , class: "text-center", style: "margin: 50px 0" %>
      <% @post.answers.each do |answer| %>
        <div class="row answer-after" data-answer-after="<%= answer.id %>">
          <div class="col-12" style="border: #777777 solid 1px; border-radius: 4px; box-shadow: 0 0 10px 5px rgba(221, 221, 221, 1);
              background-color: white; padding-bottom: 10px; padding: 20px;">
            <div class="row">
              <div class="col-6" style="padding-right: 0;">
                <p>login: <span><%= answer.user.login %></span>
                  <%= image_tag "#{answer.user.avatar.versions[:preview]}", class: "img-thumbnail" %>
                </p>
                <p>Raiting: </p>
              </div>
              <div class="col-6 text-right">
                <%= link_to 'Delete', category_post_answer_path(params[:category_id], @post.id, answer.id), method:
                    :delete, data: { confirm: "Are you sure?" }, class: "text-right" if answer.user_id ==
                    current_user.id %>
              </div>
            </div>
            <div class="row">
              <div class="col-12" style="border: #777777 solid 1px; border-radius: 4px; background-color: #f2f2f2">
                <p>Description:</p>
                <%= answer.body %>
              </div>
              <div class="col text-right">
                <br>
                <!--                количество комментариев-->
                <%= button_tag 'add comment', class: "add_comment btn btn-primary",
                               data: { answer: "#{answer.id}" } %>
              </div>
              <div class="col-12 text-right">
                <br>

                <%= link_to like_answer_category_post_path(params[:category_id], params[:id], answer_id: answer.id),
                            class: "like_answer", remote: true, method: :put do %>
                  <%= image_tag "thumb-up.png" %>
                  <span class="like-answer-size-<%= answer.id %>"><%= answer.get_upvotes.size %></span>
                <% end %>
                <%= link_to deslike_answer_category_post_path(params[:category_id], params[:id], answer_id: answer.id),
                            class: "deslike_answer", remote: true, method: :put do %>
                  <%= image_tag "thumb-down.png" %>
                  <span class="deslike-answer-size-<%= answer.id %>"><%= answer.get_downvotes.size %></span>
                <% end %>
              </div>
            </div>
          </div>
        </div>
        <br>
        <div class="container all-comments-container" data-answer-container="<%= answer.id %>">
          <%= render partial: "shared/all_comment", locals: { answer: answer }  %>
        </div>
      <% end %>
    <% else %>
      <%= content_tag :h3, "No answers yet", class: "text-center", style: "margin: 50px 0" %>
  <% end %>
  </div>
</div>

<script>

  document.addEventListener("turbolinks:load", () => {

    let comment_buttons = []

    function blabla(){
      return
    }

    function is_the_a_comment(){
      if(document.querySelector("#new_comment") != null && document.querySelector(".containerComment") != null ){
        const containerComment = document.querySelector(".containerComment")
        containerComment.parentNode.removeChild(containerComment)
        // el.setAttribute("disabled", "false")
      }else{
        blabla()
      }
    }

    const el = document.querySelectorAll("[data-answer]")

    if(el.length > 0){
      for(let i of el){
        i.onclick = function(e){
          e.preventDefault()
          let dataButton = e.target.getAttribute('data-answer')
          let dataAnswerAfter = e.target.parentElement.parentElement.parentElement.parentElement
          is_the_a_comment()
          let container = document.createElement('div');
          container.classList.add("container")
          container.classList.add("containerComment")
          // Для разнообразия добавим скрытые инпуты с id user и post id, мы же хакеры
          container.insertAdjacentHTML("afterbegin", `
        <div class='row justify-content-center' style='margin-top: 50px'>
          <div class='col-9'>
            <%= form_with model: Comment.new, url: comments_path, method: :post, id: "new_comment" do |f| %>
              <div class='form-group'>
                <%= f.label :Your_comment %>
                <%= f.text_area :body, class: 'form-control', style: 'max-height: 300px' %>
              </div>
              <%= f.hidden_field :user_id, value: current_user.id %>
              <%= f.hidden_field :answer_id, value: "${dataButton}" %>
              <%= f.hidden_field :category_id, value: params[:category_id] %>
              <div class='form-group text-right'>
                <%= f.submit 'comment', class: 'btn btn-primary' %>
              </div>
            <% end %>
          </div>
        </div>
      `)
          dataAnswerAfter.appendChild(container);
        }
      }
    }

    document.onclick = function (e) {

      if(document.querySelector("#new_comment") != null && document.querySelector(".containerComment") != null ){
        const comment = document.querySelector("#new_comment")
        const containerComment = document.querySelector(".containerComment")
        el.forEach((element) => {
          if (element.contains(e.target) == true){
            comment_buttons = element
          }
        })
        if (!comment.contains(e.target) && !comment_buttons.contains(e.target)) {
          containerComment.parentNode.removeChild(containerComment)
          return true
        }
      }else{
        blabla()
      }
    }
  });

</script>
